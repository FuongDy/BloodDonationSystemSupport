import{r as x,u as E,j as e,o as w,B as p,H as R,V as m,T as C,q as A,U as k,d as T,R as B,l as P}from"./index-CLUoxoAg.js";import{b as N}from"./bloodRequestService-C7vK5jM6.js";import{u as U}from"./useAuthRedirect-D3HqaErI.js";import{S as G}from"./StatusBadge-DgoAfm03.js";import{C as y}from"./clock-DHp9DAYO.js";import"./Badge-CK4vI7BX.js";import"./constants-CyaO7I1E.js";const M=({request:s,onPledgeSuccess:r})=>{var h,g;const[i,c]=x.useState(!1),{user:a,isAuthenticated:d}=E(),{requireAuth:t}=U(),n=(h=s.pledges)==null?void 0:h.some(u=>{var o;return((o=u.donor)==null?void 0:o.id)===(a==null?void 0:a.id)}),l=async()=>{var o;if(t(null,"Vui lòng đăng nhập để đăng ký hiến máu.")){if(n){m.error("Bạn đã đăng ký hiến máu cho yêu cầu này rồi.");return}c(!0);try{await N.pledgeForRequest(s.id),m.success("Đăng ký hiến máu thành công! Cảm ơn bạn đã tham gia cứu người."),r==null||r()}catch(v){((o=v.response)==null?void 0:o.status)===409?m.error("Bạn đã đăng ký hiến máu cho yêu cầu này rồi."):m.error("Không thể đăng ký hiến máu. Vui lòng thử lại.")}finally{c(!1)}}},j=((g=s.pledges)==null?void 0:g.length)||0,f=s.priority==="URGENT",b=s.priority==="EMERGENCY";return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center text-gray-600",children:[e.jsx(w,{className:"w-4 h-4 mr-1"}),e.jsxs("span",{children:[j," người đã đăng ký hiến"]})]}),s.quantityNeeded&&e.jsxs("div",{className:"text-gray-500",children:["Cần: ",s.quantityNeeded," đơn vị"]})]}),e.jsxs(p,{onClick:l,disabled:i||n||!d,variant:n?"outline":b?"danger":f?"warning":"primary",className:"w-full flex items-center justify-center",children:[e.jsx(R,{className:`w-4 h-4 mr-2 ${n?"fill-current":""}`}),i?"Đang xử lý...":n?"Đã đăng ký hiến máu":"Đăng ký hiến máu"]}),!d&&e.jsx("p",{className:"text-xs text-gray-500 text-center",children:"Vui lòng đăng nhập để đăng ký hiến máu"}),n&&e.jsx("p",{className:"text-xs text-green-600 text-center",children:"✓ Cảm ơn bạn đã đăng ký hiến máu cho yêu cầu này"})]})},L=({request:s,onPledgeSuccess:r,showPledgeButton:i=!0})=>{const c=l=>new Date(l).toLocaleDateString("vi-VN",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),a=l=>{switch(l){case"EMERGENCY":return"bg-red-100 text-red-800 border-red-200";case"URGENT":return"bg-orange-100 text-orange-800 border-orange-200";case"NORMAL":return"bg-blue-100 text-blue-800 border-blue-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}},d=l=>{switch(l){case"EMERGENCY":return"Khẩn cấp";case"URGENT":return"Gấp";case"NORMAL":return"Bình thường";default:return l}},t=s.priority==="EMERGENCY",n=s.priority==="URGENT";return e.jsx("div",{className:`bg-white rounded-lg shadow-md overflow-hidden border-l-4 ${t?"border-red-500":n?"border-orange-500":"border-blue-500"} hover:shadow-lg transition-shadow`,children:e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"flex justify-between items-start mb-4",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsxs("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${a(s.priority)}`,children:[(t||n)&&e.jsx(C,{className:"w-3 h-3 mr-1"}),d(s.priority)]}),e.jsx(G,{status:s.status})]}),e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-1",children:["Cần nhóm máu: ",s.bloodTypeRequired]}),s.description&&e.jsx("p",{className:"text-gray-600 text-sm mb-3",children:s.description})]})}),e.jsxs("div",{className:"space-y-3 mb-4",children:[s.quantityNeeded&&e.jsxs("div",{className:"flex items-center text-sm text-gray-600",children:[e.jsx(A,{className:"w-4 h-4 mr-2 text-red-500"}),e.jsxs("span",{children:["Số lượng cần: ",e.jsxs("strong",{children:[s.quantityNeeded," đơn vị"]})]})]}),s.requesterName&&e.jsxs("div",{className:"flex items-center text-sm text-gray-600",children:[e.jsx(k,{className:"w-4 h-4 mr-2"}),e.jsxs("span",{children:["Người yêu cầu: ",s.requesterName]})]}),s.location&&e.jsxs("div",{className:"flex items-center text-sm text-gray-600",children:[e.jsx(T,{className:"w-4 h-4 mr-2"}),e.jsxs("span",{children:["Địa điểm: ",s.location]})]}),s.neededBy&&e.jsxs("div",{className:"flex items-center text-sm text-gray-600",children:[e.jsx(y,{className:"w-4 h-4 mr-2"}),e.jsxs("span",{children:["Thời hạn: ",c(s.neededBy)]})]}),s.createdAt&&e.jsxs("div",{className:"flex items-center text-sm text-gray-500",children:[e.jsx(y,{className:"w-4 h-4 mr-2"}),e.jsxs("span",{children:["Đăng lúc: ",c(s.createdAt)]})]})]}),(s.contactPhone||s.contactEmail)&&e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3 mb-4",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900 mb-2",children:"Thông tin liên hệ:"}),e.jsxs("div",{className:"space-y-1",children:[s.contactPhone&&e.jsxs("p",{className:"text-sm text-gray-600",children:["Điện thoại:"," ",e.jsx("a",{href:`tel:${s.contactPhone}`,className:"text-blue-600 hover:underline",children:s.contactPhone})]}),s.contactEmail&&e.jsxs("p",{className:"text-sm text-gray-600",children:["Email:"," ",e.jsx("a",{href:`mailto:${s.contactEmail}`,className:"text-blue-600 hover:underline",children:s.contactEmail})]})]})]}),i&&s.status==="ACTIVE"&&e.jsx(M,{request:s,onPledgeSuccess:r})]})})},I=()=>{const[s,r]=x.useState([]),[i,c]=x.useState(!0),a=async()=>{c(!0);try{const t=await N.searchActiveRequests();console.log("API response:",t);let n=[];t.data&&Array.isArray(t.data)?n=t.data:Array.isArray(t)?n=t:(console.warn("Unexpected response format:",t),n=[]),r(n)}catch(t){console.error("Error fetching requests:",t),m.error("Không thể tải danh sách yêu cầu máu."),r([])}finally{c(!1)}};x.useEffect(()=>{a()},[]);const d=()=>{a()};return e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"text-4xl font-bold text-gray-900",children:"Các Trường Hợp Cần Máu Khẩn Cấp"}),e.jsx("p",{className:"mt-4 text-lg text-gray-600",children:"Mỗi giọt máu cho đi, một cuộc đời ở lại. Hãy cùng chung tay giúp đỡ những bệnh nhân đang cần máu."}),e.jsx("div",{className:"mt-6",children:e.jsxs(p,{onClick:a,disabled:i,variant:"outline",className:"inline-flex items-center",children:[e.jsx(B,{className:`w-4 h-4 mr-2 ${i?"animate-spin":""}`}),"Làm mới"]})})]}),i?e.jsx("div",{className:"flex justify-center items-center py-12",children:e.jsx(P,{size:"12"})}):e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:Array.isArray(s)&&s.length>0?s.map(t=>e.jsx(L,{request:t,onPledgeSuccess:d},t.id)):e.jsxs("div",{className:"col-span-full text-center py-12",children:[e.jsx("p",{className:"text-gray-500 text-lg",children:"Hiện tại không có yêu cầu khẩn cấp nào."}),e.jsx("p",{className:"text-gray-400 text-sm mt-2",children:"Hãy quay lại sau để kiểm tra các yêu cầu mới."})]})})]})};export{I as default};
