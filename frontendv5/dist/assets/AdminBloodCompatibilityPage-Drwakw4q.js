import{r,u as A,V as d,j as e,d as D,I as q,B as g,R}from"./index---XYpbwv.js";import{b as w}from"./bloodCompatibilityService-BjzIM7Q9.js";import{M}from"./Modal-CH3PBdLX.js";import{b as G}from"./bloodTypeService-DVaU63AT.js";import{P as V}from"./Pagination-Dpv6LZGB.js";import{C as K}from"./circle-plus-BMNAtK6a.js";import{C as L}from"./circle-check-big-BhElR3sU.js";import{C as F}from"./circle-x-DZIV9wQ5.js";import{P}from"./pen-line-CKq3-XG4.js";import{T as z}from"./trash-2-2oCXCowO.js";const O=({isOpen:n,onClose:N,onSaveSuccess:u,rule:a})=>{const[i,b]=r.useState({donorBloodTypeId:"",recipientBloodTypeId:"",isCompatible:!0,isEmergencyCompatible:!1,compatibilityScore:"",notes:""}),[x,T]=r.useState([]),[m,v]=r.useState(!1),[f,o]=r.useState(!1),[c,j]=r.useState({}),{user:y}=A(),C=r.useCallback(async()=>{o(!0);try{const s=await G.getAll();T(s||[])}catch(s){d.error("Lỗi khi tải danh sách loại máu: "+s.message)}finally{o(!1)}},[]);r.useEffect(()=>{n&&C()},[n,C]),r.useEffect(()=>{var s,l;b(a?{donorBloodTypeId:((s=a.donorBloodType)==null?void 0:s.id)||"",recipientBloodTypeId:((l=a.recipientBloodType)==null?void 0:l.id)||"",isCompatible:a.isCompatible,isEmergencyCompatible:a.isEmergencyCompatible,compatibilityScore:a.compatibilityScore||"",notes:a.notes||""}:{donorBloodTypeId:"",recipientBloodTypeId:"",isCompatible:!0,isEmergencyCompatible:!1,compatibilityScore:"100",notes:""}),j({})},[a,n]);const h=s=>{const{name:l,value:B,type:k,checked:$}=s.target;b(E=>({...E,[l]:k==="checkbox"?$:B})),c[l]&&j(E=>({...E,[l]:null}))},I=()=>{const s={};return i.donorBloodTypeId||(s.donorBloodTypeId="Vui lòng chọn loại máu người cho."),i.recipientBloodTypeId||(s.recipientBloodTypeId="Vui lòng chọn loại máu người nhận."),(i.compatibilityScore===""||isNaN(i.compatibilityScore))&&(s.compatibilityScore="Điểm tương thích phải là một số."),j(s),Object.keys(s).length===0},S=async s=>{if(s.preventDefault(),(y==null?void 0:y.role)!=="Admin"){d.error("Bạn không có quyền thực hiện thao tác này.");return}if(!I()){d.error("Vui lòng kiểm tra lại các trường thông tin.");return}v(!0);const l=d.loading(a?"Đang cập nhật...":"Đang tạo..."),B={donorBloodTypeId:parseInt(i.donorBloodTypeId),recipientBloodTypeId:parseInt(i.recipientBloodTypeId),isCompatible:i.isCompatible,isEmergencyCompatible:i.isEmergencyCompatible,compatibilityScore:parseFloat(i.compatibilityScore),notes:i.notes.trim()===""?null:i.notes.trim()};try{a!=null&&a.id?await w.update(a.id,B):await w.create(B),d.success(a?"Cập nhật thành công!":"Tạo thành công!",{id:l}),u()}catch(k){d.error(`Lỗi: ${k.message||"Đã có lỗi xảy ra"}`,{id:l})}finally{v(!1)}},p=(y==null?void 0:y.role)!=="Admin",t=e.jsxs(e.Fragment,{children:[e.jsx(g,{variant:"secondary",onClick:N,disabled:m||f,children:"Hủy"}),e.jsx(g,{variant:"primary",type:"submit",form:"bloodCompatibilityForm",disabled:m||f||p,isLoading:m,children:a?"Lưu thay đổi":"Tạo mới"})]});return e.jsx(M,{isOpen:n,onClose:N,title:a?"Chỉnh sửa quy tắc":"Thêm quy tắc tương thích",footerContent:t,size:"lg",children:f?e.jsx("div",{className:"flex justify-center items-center p-8",children:e.jsx(D,{})}):e.jsxs("form",{id:"bloodCompatibilityForm",onSubmit:S,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"donorBloodTypeId",className:"block text-sm font-medium text-gray-700 mb-1",children:["Loại máu người cho ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{name:"donorBloodTypeId",id:"donorBloodTypeId",value:i.donorBloodTypeId,onChange:h,disabled:m||p,required:!0,className:`block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm ${c.donorBloodTypeId?"border-red-500":"border-gray-300"}`,children:[e.jsx("option",{value:"",children:"-- Chọn loại máu --"}),x.map(s=>e.jsx("option",{value:s.id,children:`${s.bloodGroup} (${s.componentType})`},s.id))]}),c.donorBloodTypeId&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:c.donorBloodTypeId})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"recipientBloodTypeId",className:"block text-sm font-medium text-gray-700 mb-1",children:["Loại máu người nhận ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{name:"recipientBloodTypeId",id:"recipientBloodTypeId",value:i.recipientBloodTypeId,onChange:h,disabled:m||p,required:!0,className:`block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm ${c.recipientBloodTypeId?"border-red-500":"border-gray-300"}`,children:[e.jsx("option",{value:"",children:"-- Chọn loại máu --"}),x.map(s=>e.jsx("option",{value:s.id,children:`${s.bloodGroup} (${s.componentType})`},s.id))]}),c.recipientBloodTypeId&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:c.recipientBloodTypeId})]})]}),e.jsx(q,{label:"Điểm tương thích (0-100)",name:"compatibilityScore",type:"number",step:"1",min:"0",max:"100",value:i.compatibilityScore,onChange:h,required:!0,disabled:m||p,error:c.compatibilityScore}),e.jsxs("div",{className:"flex items-center space-x-8 pt-2",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{id:"isCompatible",name:"isCompatible",type:"checkbox",checked:i.isCompatible,onChange:h,disabled:m||p,className:"h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded"}),e.jsx("label",{htmlFor:"isCompatible",className:"ml-2 block text-sm text-gray-900",children:"Tương thích"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{id:"isEmergencyCompatible",name:"isEmergencyCompatible",type:"checkbox",checked:i.isEmergencyCompatible,onChange:h,disabled:m||p,className:"h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded"}),e.jsx("label",{htmlFor:"isEmergencyCompatible",className:"ml-2 block text-sm text-gray-900",children:"Tương thích khẩn cấp"})]})]}),e.jsx(q,{label:"Ghi chú (Tùy chọn)",name:"notes",as:"textarea",rows:2,value:i.notes,onChange:h,disabled:m||p,error:c.notes})]})})},te=()=>{const[n,N]=r.useState(null),[u,a]=r.useState(!1),[i,b]=r.useState(0),[x]=r.useState(10),[T,m]=r.useState(!1),[v,f]=r.useState(null),{user:o}=A(),c=r.useCallback(async(t=i,s=x)=>{a(!0);try{const l=await w.getAll(t,s);N(l)}catch(l){d.error(`Lỗi khi tải quy tắc tương thích: ${l.message}`)}finally{a(!1)}},[i,x]);r.useEffect(()=>{c()},[c]);const j=t=>{b(t)},y=()=>{c(i,x)},C=(t=null)=>{if((o==null?void 0:o.role)!=="Admin"&&t){d.error("Bạn không có quyền chỉnh sửa quy tắc tương thích.");return}if((o==null?void 0:o.role)!=="Admin"&&!t){d.error("Bạn không có quyền thêm quy tắc tương thích.");return}f(t),m(!0)},h=()=>{m(!1),f(null)},I=()=>{c(i,x),h()},S=async t=>{if((o==null?void 0:o.role)!=="Admin"){d.error("Bạn không có quyền xóa quy tắc tương thích.");return}if(window.confirm(`Bạn có chắc chắn muốn xóa quy tắc tương thích (ID: ${t}) không?`)){const s=d.loading("Đang xóa...");try{await w.delete(t),d.success("Xóa thành công!",{id:s}),n&&n.content.length===1&&i>0?b(i-1):c(i,x)}catch(l){d.error(`Lỗi khi xóa: ${l.message}`,{id:s})}}},p=t=>t?`${t.bloodGroup} (${t.componentType})`:"N/A";return e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Quản lý Tương thích máu"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(g,{onClick:y,variant:"secondary",className:"p-2",title:"Làm mới",disabled:u,children:e.jsx(R,{size:18,className:u?"animate-spin":""})}),(o==null?void 0:o.role)==="Admin"&&e.jsxs(g,{onClick:()=>C(),variant:"primary",disabled:u,children:[e.jsx(K,{size:20,className:"mr-2"})," Thêm quy tắc"]})]})]}),u&&!n?e.jsx("div",{className:"flex justify-center items-center py-10",children:e.jsx(D,{size:"12"})}):n&&n.content&&n.content.length>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-white shadow-md rounded-lg overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsx("tr",{children:["ID","Loại máu cho","Loại máu nhận","Tương thích","Khẩn cấp","Điểm","Ghi chú","Hành động"].map(t=>e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:t},t))})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:n.content.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-4 whitespace-nowrap text-sm text-gray-900",children:t.id}),e.jsx("td",{className:"px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-700",children:p(t.donorBloodType)}),e.jsx("td",{className:"px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-700",children:p(t.recipientBloodType)}),e.jsx("td",{className:"px-4 py-4 whitespace-nowrap text-sm text-center",children:t.isCompatible?e.jsx(L,{className:"text-green-500 mx-auto",size:20}):e.jsx(F,{className:"text-red-500 mx-auto",size:20})}),e.jsx("td",{className:"px-4 py-4 whitespace-nowrap text-sm text-center",children:t.isEmergencyCompatible?e.jsx(L,{className:"text-orange-500 mx-auto",size:20}):e.jsx(F,{className:"text-gray-400 mx-auto",size:20})}),e.jsx("td",{className:"px-4 py-4 whitespace-nowrap text-sm text-gray-700 text-center",children:t.compatibilityScore}),e.jsx("td",{className:"px-4 py-4 text-sm text-gray-700 max-w-xs truncate",title:t.notes,children:t.notes||"-"}),e.jsxs("td",{className:"px-4 py-4 whitespace-nowrap text-sm font-medium space-x-2",children:[(o==null?void 0:o.role)==="Admin"&&e.jsxs(e.Fragment,{children:[e.jsx(g,{onClick:()=>C(t),variant:"icon",className:"text-indigo-600 hover:text-indigo-800",title:"Chỉnh sửa",children:e.jsx(P,{size:18})}),e.jsx(g,{onClick:()=>S(t.id),variant:"icon",className:"text-red-600 hover:text-red-800",title:"Xóa",children:e.jsx(z,{size:18})})]}),(o==null?void 0:o.role)!=="Admin"&&e.jsxs(e.Fragment,{children:[e.jsx(g,{variant:"icon",className:"text-gray-400 cursor-not-allowed",title:"Không có quyền chỉnh sửa",children:e.jsx(P,{size:18})}),e.jsx(g,{variant:"icon",className:"text-gray-400 cursor-not-allowed",title:"Không có quyền xóa",children:e.jsx(z,{size:18})})]})]})]},t.id))})]})}),n.totalPages>1&&e.jsxs("div",{className:"mt-6 flex justify-between items-center",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:["Trang"," ",e.jsx("span",{className:"font-medium",children:n.number+1})," /"," ",e.jsx("span",{className:"font-medium",children:n.totalPages})," (",n.totalElements," quy tắc)"]}),e.jsx(V,{currentPage:i,totalPages:n.totalPages,onPageChange:j,isLoading:u})]})]}):e.jsx("p",{className:"text-center text-gray-500 py-8",children:"Chưa có quy tắc tương thích nào."}),T&&e.jsx(O,{isOpen:T,onClose:h,onSaveSuccess:I,rule:v})]})};export{te as default};
